<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ultimate Scanner Web</title>

<script src="jspdf.umd.min.js"></script>
<script src="tesseract.min.js"></script>

<link rel="manifest" href="manifest.json">

<style>
body { margin:0; background:#111; color:#fff; font-family:Arial, sans-serif; }
video { width:100%; height:65vh; object-fit:cover; background:black; }
.controls { text-align:center; padding:10px; }
button { margin:5px; padding:12px 14px; font-size:14px; border:none; border-radius:8px; background:#00ff88; color:#000; font-weight:bold; }
#preview { display:flex; overflow-x:auto; padding:10px; background:#1a1a1a; }
#preview img { width:90px; margin-right:8px; border-radius:6px; border:2px solid #00ff88; }
textarea { width:100%; height:140px; margin-top:10px; background:#222; color:#fff; border:none; padding:10px; font-size:14px; }
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<div class="controls">
  <button onclick="setFilter('color')">Color</button>
  <button onclick="setFilter('bw')">B&W</button>
  <button onclick="setFilter('clean')">Clean</button>
  <br>
  <button onclick="capture()">Scan Page</button>
  <button onclick="savePDF()">Save PDF</button>
  <button onclick="ocr()">OCR</button>
</div>

<div id="preview"></div>
<textarea id="text" placeholder="OCR text will appear here..."></textarea>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const { jsPDF } = window.jspdf;

let pages = [];
let filterMode = "color";

// CAMERA SETUP: Rear camera, max resolution
async function startCamera() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === "videoinput");
    let backCam = cams.find(c => /back|rear|environment/i.test(c.label));

    const stream = await navigator.mediaDevices.getUserMedia({
      video: backCam
        ? { deviceId:{exact:backCam.deviceId}, width:{ideal:3840}, height:{ideal:2160} }
        : { facingMode:"environment", width:{ideal:3840}, height:{ideal:2160} }
    });

    video.srcObject = stream;
  } catch(err) {
    alert("Camera error: "+err);
  }
}

startCamera();

// FILTERS
function applyFilter(){
  const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const d = imgData.data;
  for(let i=0;i<d.length;i+=4){
    if(filterMode==="bw"){
      let gray = d[i]*0.3 + d[i+1]*0.59 + d[i+2]*0.11;
      d[i]=d[i+1]=d[i+2]=gray;
    }
    if(filterMode==="clean"){
      let gray = d[i]*0.3 + d[i+1]*0.59 + d[i+2]*0.11;
      gray = gray>150?255:gray*1.15;
      d[i]=d[i+1]=d[i+2]=gray;
    }
    if(filterMode==="color"){
      d[i]=Math.min(255,d[i]*1.08);
      d[i+1]=Math.min(255,d[i+1]*1.08);
      d[i+2]=Math.min(255,d[i+2]*1.08);
    }
  }
  ctx.putImageData(imgData,0,0);
}

function setFilter(mode){ filterMode = mode; }

// CAPTURE
async function capture(){
  if(!video.videoWidth) return;
  await new Promise(r=>setTimeout(r, 300)); // auto-focus wait
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0);
  applyFilter();
  const img=canvas.toDataURL("image/png");
  pages.push(img);

  const thumb=document.createElement("img");
  thumb.src=img;
  document.getElementById("preview").appendChild(thumb);
}

// OCR
async function ocr(){
  if(!pages.length) return;
  document.getElementById("text").value="Processing OCR...";
  let result="";
  for(let img of pages){
    const res = await Tesseract.recognize(img,"eng");
    result+=res.data.text+"\n";
  }
  document.getElementById("text").value=result;
}

// PDF
function savePDF(){
  if(!pages.length) return;
  const pdf=new jsPDF({unit:"mm",format:"a4"});
  pages.forEach((img,i)=>{
    if(i>0) pdf.addPage();
    pdf.addImage(img,"PNG",0,0,210,297);
  });
  pdf.save("scan.pdf");
}

// PWA support
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
